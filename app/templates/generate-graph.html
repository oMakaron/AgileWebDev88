{% extends "base.html" %}
{% block title %}Generate Graph â€“ DataVizApp{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-10 px-6">
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <!-- Configuration Panel -->
    <aside class="bg-white shadow-md rounded-xl p-6 space-y-6 col-span-1 h-fit">
      <h2 class="text-xl font-semibold text-gray-800">Upload CSV & Configure</h2>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul>
            {% for category, msg in messages %}
              <li class="text-sm {{ 'text-red-600' if category == 'error' else 'text-green-600' }}">{{ msg }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <!-- Upload Form -->
      <form method="POST" enctype="multipart/form-data" class="space-y-4">
        {{ upload_form.hidden_tag() }}
        <div>
          <label class="text-sm font-medium text-gray-700">{{ upload_form.file.label }}</label>
          {{ upload_form.file(class="w-full border border-gray-300 rounded-md p-2") }}
        </div>
        <div>
          {{ upload_form.submit_upload(class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700") }}
        </div>
      </form>

      {% if show_config %}
      <div class="text-sm text-gray-600">Uploaded: <strong>{{ uploaded_filename }}</strong></div>
      <form method="POST" class="space-y-4 mt-4">
        {{ chart_form.hidden_tag() }}

        <div>
          <label class="text-sm font-medium text-gray-700">{{ chart_form.graph_type.label }}</label>
          {{ chart_form.graph_type(class="w-full p-2 border border-gray-300 rounded-md") }}
        </div>

        <!-- XY Fields -->
        <div data-chart="xy">
          <label class="text-sm text-gray-700">X Axis</label>
          {{ chart_form.x_col(class="w-full p-2 border border-gray-300 rounded-md") }}
        </div>
        <div data-chart="xy">
          <label class="text-sm text-gray-700">Y Axis</label>
          {{ chart_form.y_col(class="w-full p-2 border border-gray-300 rounded-md") }}
        </div>

        <!-- Column Field -->
        <div data-chart="histogram pie">
          <label class="text-sm text-gray-700">Column</label>
          {{ chart_form.column(class="w-full p-2 border border-gray-300 rounded-md") }}
        </div>

        <!-- Optional -->
        {% for field in [chart_form.title, chart_form.x_label, chart_form.y_label, chart_form.color, chart_form.figsize, chart_form.grid] %}
          <div>
            <label class="text-sm text-gray-700">{{ field.label }}</label>
            <span class="text-gray-400 text-sm">(optional)</span>
            {{ field(class="w-full p-2 border border-gray-300 rounded-md") }}
          </div>
        {% endfor %}

        <div class="flex justify-between gap-4">
          {{ chart_form.submit_generate(class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700") }}
          <button type="button" class="w-full bg-gray-800 text-white py-2 rounded-md hover:bg-gray-700">Save Chart</button>
        </div>
      </form>
      {% endif %}
    </aside>

    <!-- Chart Preview -->
    <main class="col-span-3 bg-white shadow-md rounded-xl p-8 flex justify-center items-center min-h-[500px]">
      {% if chart %}
        <div class="flex flex-col items-center gap-4 w-full">
          <img src="{{ chart }}" alt="Chart" class="max-w-4xl w-full border border-gray-300 rounded shadow" />
          <form method="POST">
            {{ chart_form.hidden_tag() }}
            {{ chart_form.submit_save(class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700") }}
          </form>
        </div>
      {% elif show_config %}
        <p class="text-gray-500">Select chart options and generate a preview.</p>
      {% else %}
        <p class="text-gray-500">Upload a CSV file to begin chart creation.</p>
      {% endif %}
    </main>
  </div>
</div>

<script>
  const chartRequirements = {
    line: ['x_col','y_col'], bar: ['x_col','y_col'],
    scatter: ['x_col','y_col'], area: ['x_col','y_col'],
    box: ['x_col','y_col'], histogram: ['column'],
    pie: ['column']
  };

  const showGroups = {
    line: ['xy'], bar: ['xy'], scatter: ['xy'], area: ['xy'],
    box: ['xy'], histogram: ['histogram'], pie: ['pie']
  };

  function updateChartInputs() {
    const type = document.querySelector('[name="ch-graph_type"]').value;
    document.querySelectorAll('[data-chart]').forEach(el => el.style.display = 'none');
    (showGroups[type] || []).forEach(group => {
      document.querySelectorAll(`[data-chart~="${group}"]`).forEach(el => el.style.display = '');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const selector = document.querySelector('[name="ch-graph_type"]');
    if (selector) {
      selector.addEventListener('change', updateChartInputs);
      updateChartInputs();
    }
  });
</script>
{% endblock %}

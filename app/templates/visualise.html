{% extends "base.html" %}
{% block title %}Visualise – DataVizApp{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
    <!-- Sidebar -->
    <aside class="bg-white rounded-2xl shadow-lg p-4 space-y-6 lg:col-span-2 overflow-y-auto max-h-[85vh]">
      <h2 class="text-xl font-bold text-gray-800">Upload & Configure</h2>

      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="mb-4">
            {% for category, msg in messages %}
              <li class="text-{{ 'red-600' if category=='error' else 'green-600' }}">{{ msg }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <!-- 1) Upload form -->
      <form method="POST" enctype="multipart/form-data" class="space-y-4">
        {{ upload_form.hidden_tag() }}
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ upload_form.file.label }}</label>
          {{ upload_form.file(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div>
          {{ upload_form.submit_upload(class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition") }}
        </div>
      </form>

      {% if show_config %}
      <p class="text-sm text-gray-600">
        <strong>Uploaded file:</strong> {{ uploaded_filename }}
      </p>
      <!-- 2) Chart config form -->
      <form method="POST" class="space-y-4 mt-6">
        {{ chart_form.hidden_tag() }}

        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.graph_type.label }}</label>
          {{ chart_form.graph_type(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>

        <!-- XY shared -->
        <div data-chart="xy">
          <label class="block text-sm font-medium text-gray-700">X Axis *</label>
          {{ chart_form.x_col(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div data-chart="xy">
          <label class="block text-sm font-medium text-gray-700">Y Axis *</label>
          {{ chart_form.y_col(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>

        <!-- Histogram -->
        <div data-chart="histogram">
          <label class="block text-sm font-medium text-gray-700">Column *</label>
          {{ chart_form.column(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>

        <!-- Pie -->
        <div data-chart="pie">
          <label class="block text-sm font-medium text-gray-700">Column *</label>
          {{ chart_form.column(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>

        <!-- Optional fields (same color asterisk if required) -->
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.title.label }}
            <span class="text-gray-400 text-sm">(optional)</span>
          </label>
          {{ chart_form.title(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.x_label.label }}
            <span class="text-gray-400 text-sm">(optional)</span>
          </label>
          {{ chart_form.x_label(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.y_label.label }}
            <span class="text-gray-400 text-sm">(optional)</span>
          </label>
          {{ chart_form.y_label(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.color.label }}
            <span class="text-gray-400 text-sm">(optional)</span>
          </label>
          {{ chart_form.color(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.figsize.label }}
            <span class="text-gray-400 text-sm">(optional)</span>
          </label>
          {{ chart_form.figsize(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ chart_form.grid.label }}</label>
          {{ chart_form.grid(class="w-full border border-gray-300 rounded-lg p-2") }}
        </div>

        <!-- … you can continue adding any extra fields under the appropriate data-chart groups … -->

        <div>
          {{ chart_form.submit_generate(class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition") }}
        </div>
      </form>
      {% endif %}
    </aside>

    <!-- Main Chart Display -->
    <main class="lg:col-span-3 bg-white rounded-2xl shadow-lg p-6 flex items-center justify-center">
      {% if chart %}
        <img src="{{ chart }}" alt="Generated Chart" class="w-full max-w-3xl rounded-lg shadow-md border border-gray-200">
      {% elif show_config %}
        <p class="text-gray-600">Select options to generate your chart.</p>
      {% else %}
        <p class="text-gray-600">Upload a CSV file to begin.</p>
      {% endif %}
    </main>
  </div>
</div>

<script>
  const requiredFields = {
    line: ['x_col','y_col'], bar: ['x_col','y_col'],
    scatter: ['x_col','y_col'], area: ['x_col','y_col'],
    box: ['x_col','y_col'], histogram: ['column'],
    pie: ['column']
  };
  const visibilityMap = {
    line: ['xy'], bar: ['xy'], scatter: ['xy'], area: ['xy'],
    box: ['xy'], histogram: ['histogram'], pie: ['pie']
  };

  function updateChartFields() {
    const type = document.querySelector('[name="ch-graph_type"]').value;
    document.querySelectorAll('[data-chart]').forEach(el => el.style.display = 'none');
    (visibilityMap[type]||[]).forEach(group =>
      document.querySelectorAll(`[data-chart="${group}"]`).forEach(el=>el.style.display=''));

    // reset asterisks
    document.querySelectorAll('[data-chart] label').forEach(lbl=>{
      lbl.textContent = lbl.textContent.replace(/\s\*$/, '');
    });
    // add asterisks
    (requiredFields[type]||[]).forEach(name=>{
      const lbl = document.querySelector(`[data-chart] select[name="ch-${name}"]`)?.closest('div')?.querySelector('label');
      if(lbl && !lbl.textContent.endsWith('*')) lbl.textContent += ' *';
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sel = document.querySelector('[name="ch-graph_type"]');
    if(sel) {
      sel.addEventListener('change', updateChartFields);
      updateChartFields();
    }
  });
</script>
{% endblock %}
